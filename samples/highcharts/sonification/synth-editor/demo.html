<script src="https://code.highcharts.com/highcharts.js"></script>
<script src="https://code.highcharts.com/modules/draggable-points.js"></script>
<script src="https://code.highcharts.com/modules/sonification.js"></script>

<main>
  <h1>Synth Patch Editor</h1>
  <div class="row firstrow">
    <p id="intro">Play the synth using the <span class="code">A</span> to <span class="code">L</span> and <span class="code">W</span> to <span class="code">O</span> keys on your keyboard, simulating white and black keys on a piano.</p>
    <p id="keyStatus">Synth not started</p>
  </div>

  <button id="startSynth">Start synth</button>

  <div id="controls" class="hidden">
      <div class="row">
        <label id="presetLabel">Preset <select id="preset"></select></label>
        <button id="playWideRange">Play wide range</button>
        <button id="showHelp">Help</button>
      </div>

      <div id="help" class="hidden">
        <h2>Help</h2>
        <p>Note: The synth can overdrive if you set volume too high or add many oscillators to play at once without lowering their volumes.</p>
        <p>To create volume envelopes, click in the charts to add points. The points can be dragged, or clicked to delete. The master envelopes run in addition to the oscillator envelopes if defined.</p>
        <p>The pulse width parameter only applies to oscillators with waveform type "pulse".</p>
        <p>The frequency parameters do not apply to oscillators with waveform type "whitenoise".</p>
        <p>The tracking multiplier parameters are used for frequency dependent behavior. For example, by setting the volume tracking multiplier to 0.01, the volume will be lower at higher notes. The multiplier is a logarithmic function, where 1 is at ca 50Hz, and you define the output for an input frequency around 3.2kHz.</p>
        <p>The FM and VM oscillator parameters are used for frequency modulation (FM) and volume modulation (VM). Set this parameter to one of the other oscillators to modulate its frequency or volume. Note: With pulse waveforms, the FM parameter actually controls PWM (pulse width modulation) instead of FM.</p>
      </div>

      <div id="globalControls">
        <div>
          <h2>Global controls</h2>
          <label>Master volume <input id="masterVolume" min="0.1" max="1" step="0.05" type="range" value="0.8"></label>
          <label>Glide between notes <input id="glideDuration" type="number" value="0"></label>
        </div>
        <div>
          <h3>Master Attack Envelope</h3>
          <div id="masterAttackEnvChart" class="chart"></div>
        </div>
        <div>
          <h3>Master Release Envelope</h3>
          <div id="masterReleaseEnvChart" class="chart"></div>
        </div>
        <div id="masterEQ">
          <div class="row">
            <h3>Master Parametric EQ (gain, frequency, Q)</h3>
            <button id="resetEQ">Reset</button>
          </div>
          <div id="eqSliders" class="row"></div>
        </div>
      </div>
  
      <div class="row">
        <h2>Oscillators</h2>
        <button id="addOsc">+ Add oscillator</button>
      </div>
      <div id="oscillators" class="row">
      </div>

      <h2>Generated Patch JSON</h2>
      <textarea readonly id="json">{}</textarea>
  </div>
</main>



<!-- ----------------------------------------- PRESETS STORED BELOW ------------------------------------------------ -->

<div id="presets" class="hidden">
  <div id="preset-basic">
    {
      "masterVolume": "0.8",
      "oscillators": [
       {
        "type": "sine",
        "lowpass": {},
        "highpass": {},
        "attackEnvelope": [],
        "releaseEnvelope": []
       }
      ]
     }
  </div>
  <div id="preset-whirlwind">
    {
      "masterVolume": "0.75",
      "noteGlideDuration": "400",
      "masterReleaseEnvelope": [
       {
        "t": 0,
        "vol": 1
       },
       {
        "t": 124,
        "vol": 0.24
       },
       {
        "t": 281,
        "vol": 0
       }
      ],
      "oscillators": [
       {
        "type": "whitenoise",
        "volume": 1,
        "lowpass": {
         "frequency": 100,
         "frequencyPitchTrackingMultiplier": 6,
         "Q": 23
        },
        "highpass": {
         "frequency": 170,
         "frequencyPitchTrackingMultiplier": 6
        }
       },
       {
        "type": "sine",
        "freqMultiplier": 0.016,
        "volume": 1000,
        "fmOscillator": 0
       }
      ]
     }
  </div>
  <div id="preset-saxophone">
    {
      "masterVolume": "0.9",
      "noteGlideDuration": "10",
      "masterAttackEnvelope": [
       {
        "t": 0,
        "vol": 0
       },
       {
        "t": 35,
        "vol": 1
       },
       {
        "t": 87,
        "vol": 0.84
       },
       {
        "t": 111,
        "vol": 0.6
       },
       {
        "t": 296,
        "vol": 0.49
       },
       {
        "t": 600,
        "vol": 0.58
       },
       {
        "t": 600,
        "vol": 0.58
       },
       {
        "t": 600,
        "vol": 0.58
       }
      ],
      "masterReleaseEnvelope": [
       {
        "t": 1,
        "vol": 0.58
       },
       {
        "t": 47,
        "vol": 0.16
       },
       {
        "t": 119,
        "vol": 0
       }
      ],
      "eq": [
       {
        "frequency": 200,
        "Q": 1,
        "gain": -2
       },
       {
        "frequency": 600,
        "Q": 1,
        "gain": 2
       },
       {
        "frequency": 800,
        "Q": 1,
        "gain": -10
       },
       {
        "frequency": 1100,
        "Q": 1,
        "gain": -2
       },
       {
        "frequency": 2200,
        "Q": 1,
        "gain": -2
       },
       {
        "frequency": 3500,
        "Q": 1,
        "gain": 10
       },
       {
        "frequency": 12800,
        "Q": 1,
        "gain": 4
       }
      ],
      "oscillators": [
       {
        "type": "sawtooth",
        "volume": 0.3,
        "volumePitchTrackingMultiplier": 0.06,
        "lowpass": {
         "frequency": 18,
         "frequencyPitchTrackingMultiplier": 200
        },
        "highpass": {
         "frequency": 300
        },
        "attackEnvelope": [],
        "releaseEnvelope": []
       },
       {
        "type": "whitenoise",
        "fixedFrequency": 1,
        "volume": 0.4,
        "lowpass": {},
        "highpass": {
         "frequency": 7000
        },
        "vmOscillator": 0,
        "attackEnvelope": [
         {
          "t": 1,
          "vol": 1
         },
         {
          "t": 51,
          "vol": 1
         },
         {
          "t": 86,
          "vol": 0.84
         },
         {
          "t": 500,
          "vol": 0.78
         },
         {
          "t": 500,
          "vol": 0.78
         }
        ],
        "releaseEnvelope": []
       },
       {
        "type": "sine",
        "fixedFrequency": 4,
        "volume": 2,
        "lowpass": {},
        "highpass": {},
        "fmOscillator": 0,
        "attackEnvelope": [
         {
          "t": 0,
          "vol": 0
         },
         {
          "t": 15,
          "vol": 0.94
         },
         {
          "t": 79,
          "vol": 1
         },
         {
          "t": 172,
          "vol": 0.47
         },
         {
          "t": 500,
          "vol": 0.26
         },
         {
          "t": 500,
          "vol": 0.26
         }
        ],
        "releaseEnvelope": []
       },
       {
        "type": "sine",
        "fixedFrequency": 7,
        "volume": 6,
        "lowpass": {},
        "highpass": {},
        "fmOscillator": 0,
        "attackEnvelope": [
         {
          "t": 0,
          "vol": 0
         },
         {
          "t": 25,
          "vol": 0.99
         },
         {
          "t": 85,
          "vol": 0
         },
         {
          "t": 85,
          "vol": 0
         },
         {
          "t": 387,
          "vol": 0.02
         },
         {
          "t": 511,
          "vol": 0.43
         },
         {
          "t": 600,
          "vol": 0
         }
        ],
        "releaseEnvelope": []
       }
      ]
     }
  </div>
  <div id="preset-rock">
    {
      "masterVolume": "0.8",
      "masterAttackEnvelope": [
       {
        "t": 0,
        "vol": 0
       },
       {
        "t": 8,
        "vol": 0.95
       },
       {
        "t": 39,
        "vol": 1
       },
       {
        "t": 73,
        "vol": 0.85
       }
      ],
      "masterReleaseEnvelope": [
       {
        "t": 1,
        "vol": 0.89
       },
       {
        "t": 40,
        "vol": 0.29
       },
       {
        "t": 82,
        "vol": 0.01
       }
      ],
      "eq": [
       {
        "frequency": 100,
        "Q": 1,
        "gain": -4
       },
       {
        "frequency": 500,
        "Q": 10,
        "gain": 4
       },
       {
        "frequency": 800,
        "Q": 1,
        "gain": 2
       },
       {
        "frequency": 2200,
        "Q": 1,
        "gain": 4
       },
       {
        "frequency": 3600,
        "Q": 1,
        "gain": 4
       },
       {
        "frequency": 9400,
        "Q": 0.7,
        "gain": 6
       },
       {
        "frequency": 12800,
        "Q": 1,
        "gain": 6
       }
      ],
      "oscillators": [
       {
        "type": "sawtooth",
        "volume": 2.5,
        "volumePitchTrackingMultiplier": 0.07,
        "lowpass": {
         "frequency": 1,
         "frequencyPitchTrackingMultiplier": 1000,
         "Q": -12
        },
        "highpass": {
         "frequency": 80,
         "frequencyPitchTrackingMultiplier": 22
        },
        "attackEnvelope": [],
        "releaseEnvelope": []
       },
       {
        "type": "sine",
        "fixedFrequency": 200,
        "volume": 100,
        "lowpass": {},
        "highpass": {},
        "fmOscillator": 0,
        "attackEnvelope": [
         {
          "t": 0,
          "vol": 0
         },
         {
          "t": 1,
          "vol": 1
         },
         {
          "t": 168,
          "vol": 1
         },
         {
          "t": 372,
          "vol": 0.32
         },
         {
          "t": 600,
          "vol": 0.57
         },
         {
          "t": 600,
          "vol": 0.57
         }
        ],
        "releaseEnvelope": []
       },
       {
        "type": "sawtooth",
        "freqMultiplier": 2,
        "volume": 0.01,
        "volumePitchTrackingMultiplier": 0.07,
        "lowpass": {
         "frequency": 5000
        },
        "highpass": {},
        "attackEnvelope": [],
        "releaseEnvelope": []
       },
       {
        "type": "whitenoise",
        "fixedFrequency": 1,
        "volume": 0.5,
        "lowpass": {},
        "highpass": {},
        "vmOscillator": 2,
        "attackEnvelope": [
         {
          "t": 0,
          "vol": 0
         },
         {
          "t": 1,
          "vol": 1
         },
         {
          "t": 35,
          "vol": 0.93
         },
         {
          "t": 48,
          "vol": 0.66
         }
        ],
        "releaseEnvelope": []
       },
       {
        "type": "sine",
        "fixedFrequency": 7.6,
        "volume": 0.08,
        "lowpass": {},
        "highpass": {},
        "vmOscillator": 0,
        "attackEnvelope": [
         {
          "t": 0,
          "vol": 0
         },
         {
          "t": 600,
          "vol": 0.95
         }
        ],
        "releaseEnvelope": []
       },
       {
        "type": "sine",
        "freqMultiplier": 3,
        "volume": 0.15,
        "volumePitchTrackingMultiplier": 0.07,
        "lowpass": {},
        "highpass": {},
        "attackEnvelope": [],
        "releaseEnvelope": []
       },
       {
        "type": "sine",
        "freqMultiplier": 4,
        "volume": 0.015,
        "detune": -10,
        "volumePitchTrackingMultiplier": 0.07,
        "lowpass": {},
        "highpass": {},
        "attackEnvelope": [],
        "releaseEnvelope": []
       },
       {
        "type": "sine",
        "volume": 0.08,
        "detune": -10,
        "lowpass": {},
        "highpass": {},
        "attackEnvelope": [],
        "releaseEnvelope": []
       }
      ]
     }
  </div>
  <div id="preset-vibraphone">
    {
      "masterVolume": "1",
      "masterAttackEnvelope": [
       {
        "t": 1,
        "vol": 0.63
       },
       {
        "t": 82,
        "vol": 0.64
       },
       {
        "t": 149,
        "vol": 0.26
       },
       {
        "t": 600,
        "vol": 0
       }
      ],
      "eq": [
       {
        "frequency": 200,
        "Q": 0.8,
        "gain": -12
       },
       {
        "frequency": 400,
        "Q": 1,
        "gain": -4
       },
       {
        "frequency": 1600,
        "Q": 0.5,
        "gain": 6
       },
       {
        "frequency": 2200,
        "Q": 0.5,
        "gain": 6
       },
       {
        "frequency": 6400,
        "Q": 1,
        "gain": 4
       },
       {
        "frequency": 12800,
        "Q": 1,
        "gain": 4
       }
      ],
      "oscillators": [
       {
        "type": "sine",
        "volume": 1.5,
        "volumePitchTrackingMultiplier": 0.07,
        "lowpass": {},
        "highpass": {},
        "attackEnvelope": [
         {
          "t": 1,
          "vol": 1
         }
        ],
        "releaseEnvelope": [
         {
          "t": 1,
          "vol": 1
         },
         {
          "t": 146,
          "vol": 0.39
         },
         {
          "t": 597,
          "vol": 0
         },
         {
          "t": 597,
          "vol": 0
         },
         {
          "t": 597,
          "vol": 0
         }
        ]
       },
       {
        "type": "whitenoise",
        "volume": 0.03,
        "volumePitchTrackingMultiplier": 2,
        "lowpass": {
         "frequency": 900
        },
        "highpass": {
         "frequency": 800
        },
        "attackEnvelope": [
         {
          "t": 1,
          "vol": 1
         },
         {
          "t": 9,
          "vol": 0
         }
        ],
        "releaseEnvelope": []
       },
       {
        "type": "sine",
        "freqMultiplier": 4,
        "volume": 0.15,
        "volumePitchTrackingMultiplier": 0.03,
        "lowpass": {},
        "highpass": {},
        "attackEnvelope": [],
        "releaseEnvelope": []
       },
       {
        "type": "sine",
        "fixedFrequency": 3,
        "volume": 6,
        "lowpass": {},
        "highpass": {},
        "fmOscillator": 0,
        "attackEnvelope": [],
        "releaseEnvelope": [
         {
          "t": 1,
          "vol": 1
         },
         {
          "t": 190,
          "vol": 0.41
         },
         {
          "t": 600,
          "vol": 0
         },
         {
          "t": 600,
          "vol": 0
         }
        ]
       },
       {
        "type": "sine",
        "fixedFrequency": 6,
        "volume": 3,
        "lowpass": {},
        "highpass": {},
        "fmOscillator": 2,
        "attackEnvelope": [],
        "releaseEnvelope": []
       },
       {
        "type": "sine",
        "freqMultiplier": 9,
        "volume": 0.0005,
        "volumePitchTrackingMultiplier": 0.07,
        "lowpass": {},
        "highpass": {},
        "attackEnvelope": [],
        "releaseEnvelope": [
         {
          "t": 1,
          "vol": 0.97
         },
         {
          "t": 530,
          "vol": 0
         }
        ]
       }
      ]
     }
  </div>
  <div id="preset-synth">
    {
      "masterVolume": "0.45",
      "masterAttackEnvelope": [
       {
        "t": 1,
        "vol": 0.63
       },
       {
        "t": 82,
        "vol": 0.64
       },
       {
        "t": 149,
        "vol": 0.26
       },
       {
        "t": 425,
        "vol": 0
       }
      ],
      "eq": [
       {
        "frequency": 200,
        "Q": 1,
        "gain": 6
       },
       {
        "frequency": 1600,
        "Q": 1,
        "gain": 4
       },
       {
        "frequency": 6400,
        "Q": 1,
        "gain": 6
       },
       {
        "frequency": 12800,
        "Q": 1,
        "gain": 8
       }
      ],
      "oscillators": [
       {
        "type": "pulse",
        "volume": 1,
        "pulseWidth": 0.45,
        "volumePitchTrackingMultiplier": 0.07,
        "lowpass": {
         "frequency": 45,
         "frequencyPitchTrackingMultiplier": 65,
         "Q": -2
        },
        "highpass": {
         "frequency": 370
        },
        "attackEnvelope": [
         {
          "t": 1,
          "vol": 1
         }
        ],
        "releaseEnvelope": [
         {
          "t": 1,
          "vol": 1
         },
         {
          "t": 282,
          "vol": 0.64
         },
         {
          "t": 597,
          "vol": 0
         },
         {
          "t": 597,
          "vol": 0
         }
        ]
       },
       {
        "type": "whitenoise",
        "volume": 0.7,
        "volumePitchTrackingMultiplier": 2,
        "lowpass": {
         "frequency": 400
        },
        "highpass": {
         "frequency": 400
        },
        "attackEnvelope": [
         {
          "t": 1,
          "vol": 1
         },
         {
          "t": 13,
          "vol": 0
         }
        ]
       },
       {
        "type": "sine",
        "fixedFrequency": 3,
        "volume": 0.0001,
        "fmOscillator": 0
       }
      ]
     }
  </div>
  <div id="preset-piano">
    {
      "masterVolume": "0.6",
      "masterAttackEnvelope": [
       {
        "t": 1,
        "vol": 0.71
       },
       {
        "t": 82,
        "vol": 0.64
       },
       {
        "t": 149,
        "vol": 0.26
       },
       {
        "t": 425,
        "vol": 0
       }
      ],
      "eq": [
       {
        "frequency": 200,
        "Q": 1,
        "gain": 4
       },
       {
        "frequency": 450,
        "Q": 1,
        "gain": 6
       },
       {
        "frequency": 1300,
        "Q": 1,
        "gain": 2
       },
       {
        "frequency": 2600,
        "Q": 0.8,
        "gain": 8
       },
       {
        "frequency": 3500,
        "Q": 0.8,
        "gain": 6
       },
       {
        "frequency": 6200,
        "Q": 0.8,
        "gain": 10
       },
       {
        "frequency": 8000,
        "Q": 1,
        "gain": -26
       },
       {
        "frequency": 10000,
        "Q": 0.4,
        "gain": -16
       }
      ],
      "oscillators": [
       {
        "type": "pulse",
        "volume": 0.5,
        "pulseWidth": 0.45,
        "volumePitchTrackingMultiplier": 0.07,
        "lowpass": {
         "frequency": 4.5,
         "frequencyPitchTrackingMultiplier": 900,
         "Q": -2
        },
        "highpass": {
         "frequency": 370
        },
        "attackEnvelope": [
         {
          "t": 1,
          "vol": 1
         }
        ],
        "releaseEnvelope": [
         {
          "t": 1,
          "vol": 1
         },
         {
          "t": 282,
          "vol": 0.64
         },
         {
          "t": 597,
          "vol": 0
         },
         {
          "t": 597,
          "vol": 0
         }
        ]
       },
       {
        "type": "whitenoise",
        "volume": 1,
        "lowpass": {
         "frequency": 400
        },
        "highpass": {
         "frequency": 300
        },
        "attackEnvelope": [
         {
          "t": 1,
          "vol": 1
         },
         {
          "t": 19,
          "vol": 0
         }
        ]
       }
      ]
     }
  </div>

</div>